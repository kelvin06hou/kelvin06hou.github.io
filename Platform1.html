<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Platform1</title>
<style>
body { font-family: Arial; margin: 20px; }
.question-box { border: 1px solid #ccc; padding: 15px; margin-top: 20px; }
.feedback { margin-top: 10px; padding: 8px; border-left: 3px solid #0044aa; }
</style>
</head>
<body>
<h2 id="title"></h2>
<div id="instructionText" style="border:1px solid #aaa; padding:15px; margin-bottom:20px;"></div>
<div id="questions"></div>
<button onclick="submitAssignment()">Submit</button>
<button onclick="showSubmissionRecord()">Show Submission Record</button>

<script>
const JSON_URL = "assignment1.json";
let assignmentData = null;

async function loadAssignment() {
  try {
    const res = await fetch(JSON_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("JSON load failed");
    assignmentData = await res.json();
    renderInstructions();
    renderQuestions();
  } catch (err) {
    document.getElementById("instructionText").innerText =
      "Failed to load assignment JSON.";
  }
}

function renderInstructions() {
  const box = document.getElementById("instructionText");
  box.innerHTML = assignmentData.instructions.replace(/
/g, "<br>");
  document.getElementById("title").innerText = assignmentData.title;
}

function renderQuestions() {
  const container = document.getElementById("questions");
  container.innerHTML = "";

  assignmentData.questions.forEach(q => {
    let html = `<div class='question-box'>
      <div><strong>${q.text}</strong></div>`;

    if (q.type === "mcq") {
      q.options.forEach((opt, idx) => {
        html += `<div>
          <input type='radio' name='${q.id}' value='${idx}' onchange='saveAnswer("${q.id}", ${idx})'>
          ${String.fromCharCode(65 + idx)}. ${opt}
        </div>`;
      });
    } else if (q.type === "fill") {
      html += `<input type='text' id='${q.id}' oninput='saveAnswer("${q.id}", this.value)' />`;
    }

    html += `<div id='feedback-${q.id}' class='feedback'></div>`;
    html += `</div>`;
    container.innerHTML += html;
  });
}

function saveAnswer(id, value) {
  localStorage.setItem("ans_" + id, value);
}

function getOptionLetter(index) {
  return String.fromCharCode(65 + index);
}

function submitAssignment() {
  let record = { timestamp: new Date().toLocaleString(), score: 0 };
  let totalScore = 0;

  assignmentData.questions.forEach(q => {
    const feedbackBox = document.getElementById(`feedback-${q.id}`);
    let userAnswer = localStorage.getItem(`ans_${q.id}`);
    let correct = false;
    let correctAnsText = "";

    if (q.type === "mcq") {
      const correctIndex = q.answer;
      correctAnsText = `Answer: ${getOptionLetter(correctIndex)} (${q.options[correctIndex]})`;
      if (userAnswer != null && Number(userAnswer) === correctIndex) correct = true;
    } else {
      correct = (userAnswer || "").trim().toLowerCase() === q.answer.trim().toLowerCase();
      correctAnsText = `Answer: \"${q.answer}\"`;
    }

    const marks = correct ? q.credits : 0;
    totalScore += marks;

    feedbackBox.innerHTML = `${marks}/${q.credits}<br>${correctAnsText}<br>${q.explanation}`;
  });

  record.score = totalScore;
  saveSubmissionRecord(record);
}

function saveSubmissionRecord(rec) {
  let logs = JSON.parse(localStorage.getItem("submission_logs") || "[]");
  logs.push(rec);
  localStorage.setItem("submission_logs", JSON.stringify(logs));
}

function showSubmissionRecord() {
  let logs = JSON.parse(localStorage.getItem("submission_logs") || "[]");
  let msg = logs.map((l, i) => `${i+1}. ${l.timestamp} â€” Score: ${l.score}`).join("
");
  alert(msg || "No submissions yet.");
}

window.onload = loadAssignment;
</script>
</body>
</html>