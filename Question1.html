<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Q&A Assessment</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .question { margin-bottom: 30px; padding: 0; border: none; }
    hr { margin: 20px 0; border: 0; border-top: 1px solid #ccc; }
    .answers { margin-top: 10px; padding: 10px; background: #f6f6f6; border-radius: 5px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h1>Assessment</h1>
<p id="instructions">Please answer all questions below.</p>

<div id="question-container">Loading questions...</div>
<button id="submit-btn">Submit Answers</button>
<div id="final-score" style="margin-top:20px; font-weight:bold;"></div>

<h2>Submission Records</h2>
<div id="submission-log" style="margin-top:10px; white-space:pre-line; font-size:0.95em;"></div>

<script>
  const qContainer = document.getElementById('question-container');
  const submitBtn = document.getElementById('submit-btn');
  let questions = [];

  async function loadQuestions() {
    try {
      const res = await fetch('MyQuestion.json');
      questions = await res.json();

      if (!Array.isArray(questions)) {
        qContainer.textContent = 'MyQuestion.json format error: must be a JSON array.';
        return;
      }

      window.totalCredits = questions.reduce((a,q)=>a + (q.credit || 0), 0);

      renderQuestions();
    } catch (e) {
      qContainer.textContent = 'Unable to load MyQuestion.json. Ensure it exists on your server and is valid JSON.';
    }
  }

  
  function autosaveInputs() {
    const data = {};
    questions.forEach((q, index) => {
      if (q.type === 'mcq') {
        const sel = document.querySelector(`input[name="q${index}"]:checked`);
        data[q.id] = sel ? sel.value : '';
      } else {
        const inp = document.querySelector(`input[name="q${index}"]`);
        data[q.id] = inp ? inp.value : '';
      }
    });
    localStorage.setItem('autosave_answers', JSON.stringify(data));
  }

  function loadAutosave() {
    const saved = JSON.parse(localStorage.getItem('autosave_answers') || '{}');
    questions.forEach((q, index) => {
      if (q.type === 'mcq') {
        if (saved[q.id]) {
          const radio = document.querySelector(`input[name="q${index}"][value="${saved[q.id]}"]`);
          if (radio) radio.checked = true;
        }
      } else {
        const inp = document.querySelector(`input[name="q${index}"]`);
        if (inp && saved[q.id]) inp.value = saved[q.id];
      }
    });
  }

  function renderQuestions() {
    qContainer.innerHTML = '';

    questions.forEach((q, index) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'question';

      const title = document.createElement('div');
      title.innerHTML = `<strong>Q${index+1}:</strong> ${q.text}`;
      wrapper.appendChild(title);
      // Show credit bottom-right
      if (q.credit !== undefined) {
        const creditTag = document.createElement('div');
        creditTag.style.textAlign = 'right';
        creditTag.style.fontSize = '0.9em';
        creditTag.style.color = '#555';
        creditTag.textContent = `(${q.credit} Points)`;
        wrapper.appendChild(creditTag);
      }

      if (q.type === 'mcq') {
        q.choices.forEach((c, i) => {
          const row = document.createElement('div');
          row.innerHTML = `
            <label>
              <input type="radio" name="q${index}" value="${i}"> ${c}
            </label>`;
          wrapper.appendChild(row);
        });
      }

      if (q.type === 'fill') {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.name = `q${index}`;
        inp.style.width = '300px';
        wrapper.appendChild(inp);
      }

      const answerBox = document.createElement('div');
      answerBox.className = 'answers hidden';
      answerBox.id = `answer${index}`;
      wrapper.appendChild(answerBox);

      qContainer.appendChild(wrapper);

      // autosave listeners
      if (q.type === 'mcq') {
        wrapper.addEventListener('change', autosaveInputs);
      } else {
        const inp = wrapper.querySelector('input');
        inp.addEventListener('input', autosaveInputs);
      }

      if (index < questions.length - 1) qContainer.appendChild(document.createElement('hr'));
    });
  }

  function revealAnswers() {
    questions.forEach((q, index) => {
      const ansBox = document.getElementById(`answer${index}`);

      let userAnswer;
      if (q.type === 'mcq') {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        userAnswer = selected ? q.choices[selected.value] : '(no answer)';
      } else if (q.type === 'fill') {
        const inp = document.querySelector(`input[name="q${index}"]`);
        userAnswer = inp.value || '(no answer)';
      }

      let correct;
      if (q.type === 'mcq') correct = q.choices[q.correct];
      if (q.type === 'fill') correct = q.blanks.join(', ');

      ansBox.innerHTML = `
        <div><strong>Your Answer:</strong> ${userAnswer}</div>
        <div><strong>Correct Answer:</strong> ${correct}</div>
      `;

      ansBox.classList.remove('hidden');
    });
  }

  function recordSubmission(finalPercent) {
    const log = JSON.parse(localStorage.getItem('submission_history') || '[]');
    const id = String(log.length + 1).padStart(3, '0');
    const ts = new Date();
    const timestamp = ts.getFullYear().toString().slice(2) +
                     String(ts.getMonth()+1).padStart(2,'0') +
                     String(ts.getDate()).padStart(2,'0') + '-' +
                     String(ts.getHours()).padStart(2,'0') + ':' +
                     String(ts.getMinutes()).padStart(2,'0') + ':' +
                     String(ts.getSeconds()).padStart(2,'0');

    log.push({ submissionID: id, time: timestamp, score: finalPercent });
    localStorage.setItem('submission_history', JSON.stringify(log));

    renderSubmissionLog();
  }
      log.push({ id: q.id, answer: ans, time: new Date().toISOString() });
    });
    localStorage.setItem('submission_record', JSON.stringify(log));
  }

  function calculateScore() {
    let earned = 0;
    questions.forEach((q, index) => {
      if (q.type === 'mcq') {
        const sel = document.querySelector(`input[name="q${index}"]:checked`);
        if (sel && parseInt(sel.value) === q.correct) earned += q.credit || 0;
      }
      if (q.type === 'fill') {
        const inp = document.querySelector(`input[name="q${index}"]`);
        if (inp && q.blanks.some(b => b.toLowerCase().trim() === inp.value.toLowerCase().trim())) earned += q.credit || 0;
      }
    });
    const percent = window.totalCredits ? ((earned / window.totalCredits) * 100).toFixed(2) : '0.00';
    document.getElementById('final-score').textContent = `Final Score: ${percent}%`;
    return percent;
  }

      if (q.type === 'fill') {
        const inp = document.querySelector(`input[name="q${index}"]`);
        if (inp && q.blanks.some(b => b.toLowerCase().trim() === inp.value.toLowerCase().trim())) earned += q.credit;
      }
    });

    const percent = window.totalCredits ? ((earned / window.totalCredits) * 100).toFixed(2) : '0.00';
    document.getElementById('final-score').textContent = `Final Score: ${percent}%`;
  }

  submitBtn.addEventListener('click', () => {
    revealAnswers();
    const percent = calculateScore();
    recordSubmission(percent);
  });

  function renderSubmissionLog() {
    const box = document.getElementById('submission-log');
    const log = JSON.parse(localStorage.getItem('submission_history') || '[]');
    if (log.length === 0) box.textContent = 'No submissions yet.';
    else box.textContent = log.map(r => `Submission ID-${r.submissionID} | ${r.time} | ${r.score}%`).join('\n');
  }

  loadQuestions();
  setTimeout(loadAutosave, 500);
  renderSubmissionLog();
</script>

</body>
</html>