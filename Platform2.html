<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assignment Platform</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 24px; background: #f3f4f6; color:#111827; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    .instruction { border-left: 4px solid #2563eb; padding: 12px; background: #eef4ff; border-radius: 6px; margin-bottom: 20px; }
    .question { padding: 14px; background: #f8fafc; border-radius: 8px; margin-bottom: 18px; border: 1px solid #e2e8f0; position: relative; }
    .q-sep { height: 5px; background: linear-gradient(90deg, #2563eb, transparent); border-radius: 6px; margin-bottom: 12px; }
    .q-title { font-weight: bold; margin-bottom: 8px; }
    .bar-right { position: absolute; right: 10px; top: 10px; font-size: 12px; color: #6b7280; }
    .options { display: flex; flex-direction: column; gap: 8px; }
    .option { display: flex; gap: 8px; align-items: center; cursor: pointer; }
    input[type="text"] { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }
    button { background: #2563eb; color: white; padding: 8px 14px; border: 0; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #374151; }
    .controls { display: flex; gap: 10px; align-items: center; margin-top: 18px; }
    .result { margin-top: 20px; padding: 12px; background: #ecfeff; border: 1px solid #bae6fd; border-radius: 6px; }
    .small { font-size: 13px; color: #6b7280; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Assignment</h1>
    <div class="instruction">
      <strong>Instructions</strong>
      <p id="instructionText" class="small"></p>
    </div>

    <p class="small">Questions: <span id="qcount">0</span></p>

    <form id="quizForm" onsubmit="return false;">
      <div id="questionsArea"></div>

      <div class="controls">
        <button id="submitBtn" type="button">Submit</button>
        <button id="recordsBtn" type="button" class="secondary">View Submission Records</button>
        <div style="margin-left:auto;" class="small">Autosave enabled</div>
      </div>

      <div id="feedbackArea"></div>
    </form>
  </div>

<script>
const JSON_URL = "assignment2.json";  // GitHub Pages-compatible fetch
let assignmentData = null;

async function loadAssignment() {
  try {
    const res = await fetch(JSON_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("JSON load failed");
    assignmentData = await res.json();
  } catch (err) {
    document.getElementById("instructionText").innerText = "Failed to load assignment1.json. Ensure the JSON file is in the same GitHub directory.";
  }
}

function renderInstructions() {
  if (!assignmentData || !assignmentData.instructions) return;

  // Convert \n to HTML <br> so multi-line text displays correctly
  const formatted = assignmentData.instructions.replace(/\n/g, "<br>");

  document.getElementById("instructionText").innerHTML = formatted;
}

function storageKey() { return "answers_" + (assignmentData?.assignmentId || "default"); }
function submissionKey() { return "submissions_" + (assignmentData?.assignmentId || "default"); }

function loadSaved() {
  try { return JSON.parse(localStorage.getItem(storageKey())) || {}; } catch { return {}; }
}
function saveAnswers() {
  localStorage.setItem(storageKey(), JSON.stringify(collectAnswers()));
}

function renderQuestions() {
  const container = document.getElementById("questionsArea");
  container.innerHTML = "";
  const saved = loadSaved();

  document.getElementById("instructionText").innerText = assignmentData.instructions;
  document.getElementById("title").innerText = assignmentData.title;
  document.getElementById("qcount").innerText = assignmentData.questions.length;

  assignmentData.questions.forEach((q, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "question";

    wrap.innerHTML += `
      <div class="q-sep"></div>
      <div class="q-title">${idx + 1}. ${q.text}</div>
      <div class="bar-right">${q.credits} pts</div>`;

    if (q.type === "mcq") {
      const optWrap = document.createElement("div");
      optWrap.className = "options";
      q.options.forEach((opt, i) => {
        optWrap.innerHTML += `
          <label class="option">
            <input type="radio" name="${q.id}" value="${i}"> ${opt}
          </label>`;
      });
      wrap.appendChild(optWrap);
    }
    else if (q.type === "fill") {
      const input = document.createElement("input");
      input.type = "text";
      input.name = q.id;
      wrap.appendChild(input);
    }

    if (saved[q.id] !== undefined && saved[q.id] !== null) {
      if (q.type === "mcq") {
        wrap.querySelectorAll(`input[name='${q.id}']`).forEach(r => {
          if (Number(r.value) === Number(saved[q.id])) r.checked = true;
        });
      } else wrap.querySelector("input").value = saved[q.id];
    }

    const fb = document.createElement("div");
    fb.id = "fb_" + q.id;
    fb.className = "small";
    wrap.appendChild(fb);

    wrap.addEventListener("input", saveAnswers);
    wrap.addEventListener("change", saveAnswers);

    container.appendChild(wrap);
  });
}

function collectAnswers() {
  const out = {};
  assignmentData.questions.forEach(q => {
    if (q.type === "mcq") {
      const sel = document.querySelector(`input[name='${q.id}']:checked`);
      out[q.id] = sel ? Number(sel.value) : null;
    } else {
      const inp = document.querySelector(`input[name='${q.id}']`);
      out[q.id] = inp ? inp.value.trim() : "";
    }
  });
  return out;
}

function grade(answers) {
  let earned = 0;
  let total = 0;

  const detail = assignmentData.questions.map(q => {
    total += q.credits;
    let correct = false;

    if (q.type === "mcq") correct = answers[q.id] === q.answer;
    else correct = answers[q.id].toLowerCase() === q.answer.toString().toLowerCase();

    if (correct) earned += q.credits;

    return {
      id: q.id,
      correct,
      credits: q.credits,
      earned: correct ? q.credits : 0,
      correctAnswer: q.answer,
      explanation: q.explanation || ""
    };
  });
  return { earned, total, detail };
}

function renderPerQuestionFeedback(result) {
  result.detail.forEach(d => {
    const fb = document.getElementById("fb_" + d.id);
    if (!fb) return;
    fb.innerHTML = `Marks: ${d.earned}/${d.credits}` +
      (d.explanation ? `<br>Explanation: ${d.explanation}` : "");
  });
}

function saveSubmission(result, answers) {
  const key = submissionKey();
  const list = JSON.parse(localStorage.getItem(key)) || [];
  list.push({ time: new Date().toISOString(), earned: result.earned, total: result.total, detail: result.detail, answers });
  localStorage.setItem(key, JSON.stringify(list));
}

function showRecords() {
  const key = submissionKey();
  const list = JSON.parse(localStorage.getItem(key)) || [];
  const win = window.open("", "records", "width=800,height=600");
  if (!win) return alert("Popup blocked.");

  win.document.write("<h2>Submission Records</h2>");
  if (!list.length) return win.document.write("<p>No submissions yet.</p>");

  win.document.write("<ol>");
  list.forEach(r => {
    win.document.write(`<li>${new Date(r.time).toLocaleString()} â€” ${r.earned}/${r.total}</li>`);
  });
  win.document.write("</ol>");
}

function renderResults(result) {
  document.getElementById("feedbackArea").innerHTML = `
    <div class="result">
      <strong>Score: ${result.earned} / ${result.total}</strong><br>
      <span class="small">Submitted: ${new Date().toLocaleString()}</span>
    </div>`;
}

async function initialize() {
  await loadAssignment();
  if (assignmentData) renderQuestions();

  document.getElementById("submitBtn").onclick = function () {
    const answers = collectAnswers();
    saveAnswers();
    const result = grade(answers);
    saveSubmission(result, answers);
    renderPerQuestionFeedback(result);
    renderResults(result);
  };

  document.getElementById("recordsBtn").onclick = showRecords;
}

initialize();
</script>
</body>
</html>
