<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MCQ Admin (Supabase)</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    .card { border: 1px solid #ccc; padding: 12px; margin-bottom: 12px; border-radius: 8px; }
    textarea, input, select, button { width: 100%; padding: 6px; margin-top: 6px; }
    button { cursor: pointer; }
  </style>
</head>
<body>

<h1>Admin Panel</h1>

<div class="card">
  <h3>Settings</h3>
  Deadline:
  <input id="deadline" type="datetime-local">
  Publish:
  <select id="publish">
    <option value="false">No</option>
    <option value="true">Yes</option>
  </select>
  <button onclick="saveSettings()">Save Settings</button>
</div>

<div class="card">
  <h3>Questions</h3>
  <div id="editor"></div>
  <button onclick="addQuestion()">+ Add Question</button>
  <button onclick="saveQuestions()">Save All</button>
</div>

<div class="card">
  <h3>Submissions</h3>
  <pre id="subs"></pre>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://nkfsjyfsqoulpsnktana.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rZnNqeWZzcW91bHBzbmt0YW5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzA0MzEsImV4cCI6MjA4MDU0NjQzMX0.Lp1wqwSVz9gYn_gA2-s_f1hbiL_Lxqn6jnIC9x0sx3o"
);

// ---------- SETTINGS ----------
window.saveSettings = async () => {
  const deadline = document.getElementById("deadline").value;
  const published = document.getElementById("publish").value === "true";

  const { error } = await supabase.from("settings").upsert({
    id: 1,
    deadline,
    published
  });

  if (error) alert(error.message);
  else alert("Settings saved");
};

// ---------- LOAD ----------
async function loadAll() {
  const { data: s } = await supabase.from("settings").select("*").eq("id",1).maybeSingle();
  if (s) {
    document.getElementById("deadline").value = s.deadline || "";
    document.getElementById("publish").value = String(s.published);
  }

  const { data: q } = await supabase.from("questions").select("*").order("id");
  render(q || []);

  const { data: sub } = await supabase.from("submissions").select("*");
  document.getElementById("subs").textContent = JSON.stringify(sub, null, 2);
}

function render(questions) {
  const ed = document.getElementById("editor");
  ed.innerHTML = "";
  questions.forEach(q => {
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `
      <textarea class="q">${q.text}</textarea>
      <textarea class="o">${q.options.join("\n")}</textarea>
      <input class="a" value="${q.answer}">
    `;
    ed.appendChild(d);
  });
}

// ---------- ADD ----------
window.addQuestion = () => {
  const d = document.createElement("div");
  d.className = "card";
  d.innerHTML = `
    <textarea class="q"></textarea>
    <textarea class="o">A\nB\nC\nD</textarea>
    <input class="a">
  `;
  document.getElementById("editor").appendChild(d);
};

// ---------- SAVE ----------
window.saveQuestions = async () => {
  await supabase.from("questions").delete().neq("id",0);

  const cards = document.querySelectorAll("#editor .card");
  for (const c of cards) {
    const text = c.querySelector(".q").value;
    const options = c.querySelector(".o").value.split("\n");
    const answer = c.querySelector(".a").value.toUpperCase();

    const { error } = await supabase.from("questions").insert({
      text, options, answer
    });

    if (error) {
      alert(error.message);
      return;
    }
  }

  alert("All questions saved");
  loadAll();
};

loadAll();
</script>
</body>
</html>