<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MCQ Admin (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    label { font-weight: bold; }
    input, textarea, select, button { padding: 8px; }
    textarea { width: 100%; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .danger { background: #a00; color: white; }
  </style>
</head>
<body>
<div class="container">
  <h1>Admin â€” MCQ (Supabase)</h1>

  <div class="card">
    <h2>Exam Settings</h2>
    <div class="row">
      <div>
        <label>Deadline</label><br />
        <input type="datetime-local" id="deadline" />
      </div>
      <div>
        <label>Publish Results</label><br />
        <select id="publishFlag">
          <option value="false">Not Published</option>
          <option value="true">Published</option>
        </select>
      </div>
    </div>
    <br />
    <button id="saveSettingsBtn">Save Settings</button>
  </div>

  <div class="card">
    <h2>Question Bank</h2>
    <div id="questionEditor"></div>
    <button id="addQuestionBtn">Add Question</button>
    <button id="saveQuestionsBtn">Save All Questions</button>
  </div>

  <div class="card">
    <h2>Submissions & Auto-Marking</h2>
    <div id="submissionTable"></div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://nkfsjyfsqoulpsnktana.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rZnNqeWZzcW91bHBzbmt0YW5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzA0MzEsImV4cCI6MjA4MDU0NjQzMX0.Lp1wqwSVz9gYn_gA2-s_f1hbiL_Lxqn6jnIC9x0sx3o';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function loadAdmin() {
  const { data: settings } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
  if (settings) {
    document.getElementById('deadline').value = settings.deadline ? new Date(settings.deadline).toISOString().slice(0,16) : '';
    document.getElementById('publishFlag').value = String(settings.published);
  }

  const { data: questions } = await supabase.from('questions').select('*').order('id');
  renderEditor(questions || []);

  loadSubmissions();
}

document.getElementById('saveSettingsBtn').onclick = async () => {
  const deadline = document.getElementById('deadline').value || null;
  const published = document.getElementById('publishFlag').value === 'true';
  await supabase.from('settings').upsert({ id:1, deadline, published });
  alert('Settings saved');
};

function renderEditor(questions) {
  const container = document.getElementById('questionEditor');
  container.innerHTML = '';
  questions.forEach((q,i) => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <label>Question ${i+1}</label><br>
      <textarea class="q-text">${q.text}</textarea><br>
      <label>Options (one per line)</label><br>
      <textarea class="q-options">${q.options.join('\n')}</textarea><br>
      <label>Correct Answer</label><br>
      <input class="q-answer" value="${q.answer}">
    `;
    container.appendChild(div);
  });
}

document.getElementById('addQuestionBtn').onclick = () => {
  const container = document.getElementById('questionEditor');
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <label>New Question</label><br>
    <textarea class="q-text"></textarea><br>
    <label>Options</label><br>
    <textarea class="q-options">A\nB\nC\nD</textarea><br>
    <label>Correct Answer</label><br>
    <input class="q-answer">
  `;
  container.appendChild(div);
};

document.getElementById('saveQuestionsBtn').onclick = async () => {
  const cards = document.querySelectorAll('.card .q-text');
  await supabase.from('questions').delete().neq('id',0);

  const all = document.querySelectorAll('.card');
  for (let card of all) {
    const text = card.querySelector('.q-text');
    if (!text) continue;

    const options = card.querySelector('.q-options').value.split('\n');
    const answer = card.querySelector('.q-answer').value.toUpperCase();

    await supabase.from('questions').insert({ text: text.value, options, answer });
  }

  alert('Questions saved');
  loadAdmin();
};

async function loadSubmissions() {
  const { data: subs } = await supabase.from('submissions').select('*');
  const { data: qs } = await supabase.from('questions').select('*');

  let html = `<table><tr><th>Name</th><th>Score</th></tr>`;
  subs.forEach(s => {
    let score = 0;
    s.answers.forEach((a,i)=>{
      if (a === qs[i]?.answer) score++;
    });
    html += `<tr><td>${s.name}</td><td>${score}/${qs.length}</td></tr>`;
  });
  html += `</table>`;
  document.getElementById('submissionTable').innerHTML = html;
}

loadAdmin();
</script>
</body>
</html>