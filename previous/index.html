<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>File management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #f5f6f8; }
    header { background: #1f2937; color: #fff; padding: 16px 24px; font-size: 20px; }
    main { padding: 24px; max-width: 1300px; margin: 0 auto; }
    .layout { display: grid; grid-template-columns: 260px 1fr; gap: 20px; }
    .toolbar { display: flex; gap: 12px; margin-bottom: 16px; }
    button { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-danger { background: #dc2626; color: #fff; }
    .hidden { display: none; }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { background: #f3f4f6; font-weight: 700; }
    tr:last-child td { border-bottom: none; }

    input[type="text"] { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }
    .subtitle-badge { background: #eef2ff; color: #3730a3; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; display: inline-block; }
    .warning { color: #b45309; font-size: 12px; }
    .footer-note { margin-top: 16px; color: #6b7280; font-size: 13px; }

    /* TAG SIDEBAR */
    .tag-panel { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content; }
    .tag-panel h3 { margin: 0 0 10px 0; }
    .tag-item { padding: 8px 10px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
    .tag-item:hover { background: #f3f4f6; }
    .tag-item.active { background: #2563eb; color: #fff; }
    .tag-count { font-size: 12px; opacity: 0.7; }
    .clear-filter { margin-top: 10px; font-size: 13px; cursor: pointer; color: #2563eb; }
  </style>
</head>
<body>
  <header>File management</header>
  <main>
    <div class="toolbar">
      <button id="editBtn" type="button" class="btn-primary">Edit</button>
      <button id="saveBtn" type="button" class="btn-secondary hidden">Save</button>
      <input id="fileInput" type="file" multiple class="hidden" />
    </div>

    <div class="layout">
      
      <!-- TAG SIDEBAR (SUBPAGE-LIKE FILTER) -->
      <aside class="tag-panel">
        <h3>Tags / Subjects</h3>
        <div id="tagList">(no tags)</div>
        <div id="clearFilter" class="clear-filter hidden" role="button" tabindex="0">Clear filter</div>
      </aside>

      <!-- FILE TABLE -->
      <section>
        <table>
          <thead>
            <tr>
              <th style="width: 28%">Filename</th>
              <th style="width: 32%">Tags (comma separated)</th>
              <th style="width: 15%">Preferred Type</th>
              <th style="width: 15%">Open</th>
              <th style="width: 10%">Remove</th>
            </tr>
          </thead>
          <tbody id="fileTable"></tbody>
        </table>

        <div class="footer-note">
          Notes: Static site. Files open only during this browser session. Filenames and tags are saved in local storage.
        </div>
      </section>

    </div>
  </main>

  <script>
    // Wrap everything in DOMContentLoaded to ensure elements exist
    document.addEventListener('DOMContentLoaded', () => {
      const editBtn = document.getElementById('editBtn');
      const saveBtn = document.getElementById('saveBtn');
      const fileInput = document.getElementById('fileInput');
      const fileTable = document.getElementById('fileTable');
      const tagList = document.getElementById('tagList');
      const clearFilter = document.getElementById('clearFilter');

      let editMode = false;
      let activeTag = null;
      let files = JSON.parse(localStorage.getItem('fileManagerData') || '[]');

      const preferredExtensions = ['.pdf', '.docx', '.pptx'];
      const sessionFileMap = new Map();

      // Helper: save to localStorage
      function persist() {
        try { localStorage.setItem('fileManagerData', JSON.stringify(files)); }
        catch (e) { console.warn('Could not persist to localStorage', e); }
      }

      function renderFiles() {
        fileTable.innerHTML = '';

        const visibleFiles = activeTag
          ? files.filter(f => (f.tags || []).includes(activeTag))
          : files;

        // A -> Z with numeric ordering
        visibleFiles.sort((a, b) => a.filename.localeCompare(b.filename, undefined, { numeric: true, sensitivity: 'base' }));

        if (visibleFiles.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'No files found.';
          td.style.padding = '18px';
          tr.appendChild(td);
          fileTable.appendChild(tr);
          return;
        }

        visibleFiles.forEach((file) => {
          const tr = document.createElement('tr');

          const filenameTd = document.createElement('td');
          if (editMode) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = file.filename;
            input.oninput = (e) => file.filename = e.target.value;
            filenameTd.appendChild(input);
          } else filenameTd.textContent = file.filename;

          const tagTd = document.createElement('td');
          if (editMode) {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'e.g. Finance, Report, HR';
            input.value = (file.tags || []).join(', ');
            input.oninput = (e) => file.tags = e.target.value.split(',').map(t => t.trim()).filter(Boolean);
            tagTd.appendChild(input);
          } else {
            if (file.tags && file.tags.length) file.tags.forEach(t => {
              const badge = document.createElement('span');
              badge.className = 'subtitle-badge';
              badge.textContent = t;
              tagTd.appendChild(badge);
            });
            else tagTd.textContent = '-';
          }

          const typeTd = document.createElement('td');
          const matched = preferredExtensions.find(ext => file.filename.toLowerCase().endsWith(ext));
          if (matched) typeTd.textContent = matched.toUpperCase();
          else {
            const span = document.createElement('span');
            span.className = 'warning';
            span.textContent = 'Non-preferred';
            typeTd.appendChild(span);
          }

          const openTd = document.createElement('td');
          const openBtn = document.createElement('button');
          openBtn.textContent = 'Open';
          openBtn.type = 'button';
          openBtn.className = 'btn-secondary';
          openBtn.onclick = () => {
            const url = sessionFileMap.get(file.id);
            if (url) window.open(url, '_blank');
            else alert('File content not available in this session.');
          };
          openTd.appendChild(openBtn);

          const removeTd = document.createElement('td');
          if (editMode) {
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Delete';
            removeBtn.type = 'button';
            removeBtn.className = 'btn-danger';
            removeBtn.onclick = () => {
              sessionFileMap.delete(file.id);
              files = files.filter(x => x.id !== file.id);
              renderFiles();
              renderTags();
            };
            removeTd.appendChild(removeBtn);
          } else removeTd.textContent = '-';

          tr.appendChild(filenameTd);
          tr.appendChild(tagTd);
          tr.appendChild(typeTd);
          tr.appendChild(openTd);
          tr.appendChild(removeTd);

          fileTable.appendChild(tr);
        });
      }

      function renderTags() {
        const tagMap = {};
        files.forEach(f => (f.tags || []).forEach(t => {
          if (!tagMap[t]) tagMap[t] = 0;
          tagMap[t]++;
        }));

        tagList.innerHTML = '';
        const tagNames = Object.keys(tagMap).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));

        if (tagNames.length === 0) {
          tagList.textContent = '(no tags)';
          return;
        }

        tagNames.forEach(tag => {
          if (activeTag === tag) return; // hide active tag from sidebar

          const div = document.createElement('div');
          div.className = 'tag-item';
          div.tabIndex = 0;
          div.innerHTML = `<span>${tag}</span><span class=\"tag-count\">${tagMap[tag]}</span>`;
          div.onclick = () => {
            activeTag = tag;
            clearFilter.classList.remove('hidden');
            renderTags();
            renderFiles();
          };
          div.onkeypress = (e) => { if (e.key === 'Enter' || e.key === ' ') div.onclick(); };
          tagList.appendChild(div);
        });
      }

      // Event bindings
      editBtn.addEventListener('click', () => {
        editMode = true;
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        fileInput.classList.remove('hidden');
        renderFiles();
      });

      saveBtn.addEventListener('click', () => {
        editMode = false;
        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        fileInput.classList.add('hidden');
        persist();
        renderFiles();
        renderTags();
        alert('Changes saved locally.');
      });

      fileInput.addEventListener('change', (e) => {
        const selectedFiles = Array.from(e.target.files || []);

        selectedFiles.forEach(file => {
          const id = crypto.randomUUID();
          try { const url = URL.createObjectURL(file); sessionFileMap.set(id, url); }
          catch (err) { console.warn('Could not create object URL', err); }

          files.push({ id, filename: file.name, tags: [] });
        });

        fileInput.value = '';
        renderFiles();
        renderTags();
      });

      clearFilter.addEventListener('click', () => {
        activeTag = null;
        clearFilter.classList.add('hidden');
        renderTags();
        renderFiles();
      });

      // Initial render
      renderFiles();
      renderTags();
    });
  </script>
</body>
</html>
