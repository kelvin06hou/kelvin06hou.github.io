<!DOCTYPE html>
<html>
<head>
  <title>Student Exam</title>
</head>
<body>

<h2>Student Exam System</h2>

<input id="assignmentId" placeholder="Assignment ID"><br><br>
<input id="studentName" placeholder="Student Name"><br><br>

<button onclick="loadExam()">Load Exam</button>

<div id="exam"></div>
<button onclick="submit()">Submit</button>

<script>
let examData = {};
let answers = {};

async function loadExam() {
  const id = assignmentId.value;
  const res = await fetch(`https://api.github.com/gists/${id}`);
  const data = await res.json();
  const file = data.files["exam.json"];

  examData = JSON.parse(file.content);

  let html = `<h3>${examData.title}</h3>`;

  examData.questions.forEach(q => {
    html += `<p>${q.qnum}. ${q.question}</p>`;

    if (q.type === "SINGLE") {
      q.options.forEach(opt => {
        html += `<input type="radio" name="${q.qnum}" onclick="answers[${q.qnum}]='${opt}'">${opt}<br>`;
      });
    }

    if (q.type === "FILL") {
      html += `<input oninput="answers[${q.qnum}]=this.value"><br>`;
    }

    if (q.type === "ESSAY") {
      html += `<textarea oninput="answers[${q.qnum}]=this.value"></textarea><br>`;
    }
  });

  exam.innerHTML = html;
}

async function submit() {
  const token = prompt("GitHub Token:");
  const id = assignmentId.value;

  const submission = {
    name: studentName.value,
    time: new Date().toISOString(),
    answers
  };

  const res = await fetch(`https://api.github.com/gists/${id}`);
  const gist = await res.json();

  let oldData = gist.files["submissions.json"]
    ? JSON.parse(gist.files["submissions.json"].content)
    : [];

  oldData.push(submission);

  await fetch(`https://api.github.com/gists/${id}`, {
    method: "PATCH",
    headers: {
      "Authorization": "token " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      files: {
        "submissions.json": {
          content: JSON.stringify(oldData, null, 2)
        }
      }
    })
  });

  alert("Submission recorded successfully.");
}
</script>
</body>
</html>