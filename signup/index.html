<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Time Sign In / Out</title>
  <style>
    :root {
      --primary: #2563eb;
      --danger: #dc2626;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .container { max-width: 430px; margin: 0 auto; padding: 16px; }
    header { text-align: center; padding: 24px 0 16px; }
    header h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
    .circle-btn {
      width: 220px; height: 220px; border-radius: 50%; border: none;
      font-size: 1.3rem; font-weight: 700; color: #fff; background: var(--primary);
      display: flex; align-items: center; justify-content: center; margin: 24px auto;
      cursor: pointer; box-shadow: 0 10px 25px rgba(37,99,235,0.3);
    }
    .circle-btn.signout { background: var(--danger); box-shadow: 0 10px 25px rgba(220,38,38,0.3); }
    .status { text-align: center; font-size: 0.95rem; color: var(--muted); margin-bottom: 16px; }
    .month-section { margin-top: 24px; }
    .month-title { font-size: 1.1rem; font-weight: 700; margin: 16px 0 8px; }
    .card { background: var(--card); border-radius: 14px; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 8px 4px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    th { color: var(--muted); font-weight: 600; font-size: 0.8rem; }
    tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Time Sign In / Out</h1></header>
    <button id="signBtn" class="circle-btn">SIGN IN</button>
    <div id="status" class="status">Not signed in</div>
    <div id="records"></div>
  </div>

  <script>
    const STORAGE_KEY = 'timeRecords';
    const STATE_KEY = 'currentState';
    const ACTIVE_KEY = 'activeRecord';

    const signBtn = document.getElementById('signBtn');
    const statusText = document.getElementById('status');
    const recordsDiv = document.getElementById('records');

    const loadRecords = () => {
      try {
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY));
        return Array.isArray(raw) ? raw : [];
      } catch {
        return [];
      }
    };

    const saveRecords = d => localStorage.setItem(STORAGE_KEY, JSON.stringify(d));

    const fmtDate = ms => {
      const d = new Date(ms);
      const month = d.toLocaleString('en-US', { month: 'short' });
      const day = d.getDate();
      return `${month} ${day}`;
    };

    const fmtTime = ms => {
      const d = new Date(ms);
      const hours = d.getHours().toString().padStart(2, '0');
      const minutes = d.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    };

    const monthKey = ms => {
      const d = new Date(ms);
      return `${d.getFullYear()}-${d.getMonth()}`;
    };

    const monthTitle = ms => new Date(ms).toLocaleString('default', { month: 'long', year: 'numeric' });
    const hoursBetween = (a, b) => ((b - a) / 36e5).toFixed(2);

    function render() {
      const now = Date.now();
      const all = loadRecords().filter(r => r && typeof r.signInMs === 'number' && r.signInMs <= now);

      const groups = {};
      all.forEach(r => {
        const key = monthKey(r.dateMs);
        if (!groups[key]) groups[key] = [];
        groups[key].push(r);
      });

      const sortedMonthKeys = Object.keys(groups).sort((a, b) => {
        const [ay, am] = a.split('-').map(Number);
        const [by, bm] = b.split('-').map(Number);
        return by !== ay ? by - ay : bm - am;
      });

      recordsDiv.innerHTML = '';

      sortedMonthKeys.forEach(key => {
        const rows = groups[key]
          .filter(r => r.signInMs <= now)
          .sort((a, b) => b.signInMs - a.signInMs);

        if (!rows.length) return;

        const section = document.createElement('div');
        section.className = 'month-section';

        const title = document.createElement('div');
        title.className = 'month-title';
        title.textContent = monthTitle(rows[0].dateMs);

        const card = document.createElement('div');
        card.className = 'card';

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th>Date</th>
              <th>Sign In</th>
              <th>Sign Out</th>
              <th>Hours</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => {
              let hrs = '-';
              if (typeof r.signOutMs === 'number' && r.signOutMs <= now) {
                hrs = hoursBetween(r.signInMs, r.signOutMs);
              }
              return `
                <tr>
                  <td>${fmtDate(r.dateMs)}</td>
                  <td>${fmtTime(r.signInMs)}</td>
                  <td>${r.signOutMs && r.signOutMs <= now ? fmtTime(r.signOutMs) : '-'}</td>
                  <td>${hrs}</td>
                </tr>`;
            }).join('')}
          </tbody>`;

        card.appendChild(table);

        const total = rows.reduce((sum, r) => {
          if (r.signOutMs && r.signOutMs <= now) {
            return sum + (r.signOutMs - r.signInMs) / 36e5;
          }
          return sum;
        }, 0);

        const totalText = document.createElement('div');
        totalText.style.marginTop = '8px';
        totalText.style.fontSize = '0.85rem';
        totalText.style.color = 'var(--muted)';
        totalText.textContent = `Total hours this month: ${total.toFixed(2)} hrs`;

        card.appendChild(totalText);
        section.appendChild(title);
        section.appendChild(card);
        recordsDiv.appendChild(section);
      });
    }

    function updateButton() {
      const state = localStorage.getItem(STATE_KEY) || 'signedOut';
      signBtn.textContent = state === 'signedIn' ? 'SIGN OUT' : 'SIGN IN';
      signBtn.classList.toggle('signout', state === 'signedIn');
      statusText.textContent = state === 'signedIn' ? 'Signed in' : 'Not signed in';
    }

    signBtn.addEventListener('click', () => {
      const now = Date.now();
      const records = loadRecords();
      const state = localStorage.getItem(STATE_KEY) || 'signedOut';

      if (state === 'signedOut') {
        records.push({ dateMs: now, signInMs: now, signOutMs: null });
        localStorage.setItem(ACTIVE_KEY, records.length - 1);
        localStorage.setItem(STATE_KEY, 'signedIn');
      } else {
        const idx = Number(localStorage.getItem(ACTIVE_KEY));
        if (!Number.isNaN(idx) && records[idx]) {
          records[idx].signOutMs = now;
        }
        localStorage.setItem(STATE_KEY, 'signedOut');
        localStorage.removeItem(ACTIVE_KEY);
      }

      saveRecords(records);
      updateButton();
      render();
    });

    console.assert(Array.isArray(loadRecords()), 'loadRecords() must return an array');

    updateButton();
    render();
  </script>
</body>
</html>