<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MCQ Student (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    button { padding: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <h1>MCQ Result Page (Firebase)</h1>

  <div class="card">
    <strong>Deadline:</strong> <span id="deadlineDisplay"></span><br />
    <strong>Status:</strong> <span id="statusDisplay"></span>
  </div>

  <div class="card">
    <label>Your Name</label><br />
    <input type="text" id="studentName" />
  </div>

  <div id="questionList"></div>

  <button id="submitBtn" onclick="submitAnswers()">Submit</button>

  <div id="resultSection" class="card hidden"></div>
</div>

<script type="module">
  // ================= FIREBASE CONFIG (YOUR PROJECT) =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-IaeYoBz6CiJAs8tusAt-dxU8B4lwi_0",
    authDomain: "kelvin06hou-id.firebaseapp.com",
    databaseURL: "https://kelvin06hou-id-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kelvin06hou-id",
    storageBucket: "kelvin06hou-id.firebasestorage.app",
    messagingSenderId: "163838748410",
    appId: "1:163838748410:web:ff81a549ab6bc44f84cb43",
    measurementId: "G-YQ5RH9HLM4"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const settingsRef = ref(db, 'settings');
  const questionsRef = ref(db, 'questions');
  const submissionsRef = ref(db, 'submissions');

  async function loadStudent() {
    const settingsSnap = await get(settingsRef);
    const questionsSnap = await get(questionsRef);

    const settings = settingsSnap.val() || {};
    const questions = questionsSnap.val() || [];

    document.getElementById('deadlineDisplay').textContent = settings.deadline || 'Not Set';

    const now = new Date();
    if (settings.deadline && now > new Date(settings.deadline)) {
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('statusDisplay').textContent = 'Closed';
    } else {
      document.getElementById('statusDisplay').textContent = 'Open';
    }

    const container = document.getElementById('questionList');
    container.innerHTML = '';

    questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.className = 'card';
      let optionsHTML = '';

      q.options.forEach(opt => {
        optionsHTML += `<label><input type="radio" name="q${i}" value="${opt[0]}" /> ${opt}</label><br />`;
      });

      div.innerHTML = `<strong>Q${i + 1}:</strong> ${q.text}<br />${optionsHTML}`;
      container.appendChild(div);
    });
  }

  window.submitAnswers = async function () {
    const name = document.getElementById('studentName').value.trim();
    if (!name) return alert('Please enter your name');

    const questionsSnap = await get(questionsRef);
    const questions = questionsSnap.val() || [];

    const answers = questions.map((_, i) => {
      const checked = document.querySelector(`input[name="q${i}"]:checked`);
      return checked ? checked.value : '';
    });

    await push(submissionsRef, {
      name,
      answers,
      timestamp: Date.now()
    });

    showResult(name, answers);
  };

  async function showResult(name, answers) {
    const settingsSnap = await get(settingsRef);
    const questionsSnap = await get(questionsRef);

    const settings = settingsSnap.val() || {};
    const questions = questionsSnap.val() || [];

    const resultDiv = document.getElementById('resultSection');
    resultDiv.classList.remove('hidden');

    if (!settings.published) {
      resultDiv.innerHTML = '<strong>Submission received. Results not published yet.</strong>';
      return;
    }

    let score = 0;
    let html = `<h2>Result for ${name}</h2>`;

    questions.forEach((q, i) => {
      const correct = q.answer === answers[i];
      if (correct) score++;
      html += `<div>Q${i + 1}: Your Answer = ${answers[i] || '-'} | Correct = ${q.answer} | ${correct ? 'Correct' : 'Wrong'}</div>`;
    });

    html += `<h3>Total Score: ${score}/${questions.length}</h3>`;
    resultDiv.innerHTML = html;
  }

  loadStudent();
</script>
</body>
</html>