<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MCQ Student (Supabase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.5; }
    .container { max-width: 900px; margin: 0 auto; }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 12px; margin-bottom: 16px; }
    button { padding: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <h1>MCQ â€” Student (Supabase)</h1>

  <div class="card">
    <strong>Deadline:</strong> <span id="deadlineDisplay"></span><br />
    <strong>Status:</strong> <span id="statusDisplay"></span>
  </div>

  <div class="card">
    <label>Your Name</label><br />
    <input type="text" id="studentName" />
  </div>

  <div id="questionList"></div>

  <button id="submitBtn">Submit</button>

  <div id="resultSection" class="card hidden"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://nkfsjyfsqoulpsnktana.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rZnNqeWZzcW91bHBzbmt0YW5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzA0MzEsImV4cCI6MjA4MDU0NjQzMX0.Lp1wqwSVz9gYn_gA2-s_f1hbiL_Lxqn6jnIC9x0sx3o';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function loadStudent() {
  const { data: settings } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
  const { data: questions } = await supabase.from('questions').select('*').order('id', {ascending:true});

  document.getElementById('deadlineDisplay').textContent = settings?.deadline || 'Not Set';

  const now = new Date();
  if (settings?.deadline && now > new Date(settings.deadline)) {
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('statusDisplay').textContent = 'Closed';
  } else {
    document.getElementById('statusDisplay').textContent = 'Open';
  }

  const container = document.getElementById('questionList'); container.innerHTML = '';
  (questions||[]).forEach((q, i) => {
    const div = document.createElement('div'); div.className = 'card';
    let optionsHTML = '';
    (q.options||[]).forEach(opt => { optionsHTML += `<label><input type="radio" name="q${i}" value="${opt[0]}" /> ${opt}</label><br>`; });
    div.innerHTML = `<strong>Q${i+1}:</strong> ${q.text}<br>${optionsHTML}`;
    container.appendChild(div);
  });
}

// submit
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('studentName').value.trim();
  if (!name) return alert('Please enter your name');

  const { data: questions } = await supabase.from('questions').select('*').order('id', {ascending:true});
  const answers = questions.map((_, i) => { const checked = document.querySelector(`input[name="q${i}"]:checked`); return checked ? checked.value : ''; });

  const { error } = await supabase.from('submissions').insert({ name, answers });
  if (error) return alert('Submit failed: '+error.message);

  showResult(name, answers);
});

async function showResult(name, answers) {
  const { data: settings } = await supabase.from('settings').select('*').eq('id',1).maybeSingle();
  const { data: questions } = await supabase.from('questions').select('*').order('id', {ascending:true});

  const resultDiv = document.getElementById('resultSection'); resultDiv.classList.remove('hidden');
  if (!settings?.published) {
    resultDiv.innerHTML = '<strong>Submission received. Results not published yet.</strong>';
    return;
  }

  let score = 0; let html = `<h2>Result for ${name}</h2>`;
  (questions||[]).forEach((q, i) => { const correct = q.answer === answers[i]; if (correct) score++; html += `<div>Q${i+1}: Your Answer = ${answers[i] || '-'} | Correct = ${q.answer} | ${correct ? 'Correct':'Wrong'}</div>`; });
  html += `<h3>Total Score: ${score}/${questions.length}</h3>`;
  resultDiv.innerHTML = html;
}

loadStudent();
</script>
</body>
</html>