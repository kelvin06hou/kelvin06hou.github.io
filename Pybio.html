<!doctype html>
<html lang="zh-Hant">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Notebook Embed</title>
		<style>
			body { font-family: Arial, sans-serif; margin: 24px; }
			.frame-wrap { width: 100%; height: auto; border: none; padding: 12px; box-sizing: border-box; }
			.fallback { margin-top: 12px; }
			/* Notebook styles */
			.nb-root { max-width: 100%; }
			.nb-root h2 { margin: 0 0 12px 0; }
			.nb-cell { margin: 10px 0; border-radius: 6px; overflow: hidden; }
			.nb-markdown { padding: 8px 12px; background: #fff; }
			.nb-code { border: 1px solid #e6e6e6; position: relative; padding-left: 0; box-sizing: border-box; }
			.nb-code { border-left: 6px solid var(--bar-color, #9bb8ff); }
			.nb-cell > .nb-outputs { padding: 8px; background: #fafafa; margin-top:8px; border-radius:6px; }
			/* code block: each line is its own row with alternating background */
			.nb-code pre { margin: 0; }
			.nb-code pre code { display: block; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; white-space: pre; }
			.nb-code pre code .code-line { display: block; padding: 6px 8px; font-size: 0.95rem; line-height: 1.4; }
			.nb-code pre code .code-line:nth-child(odd) { background: #f7f7f7; }
			.nb-code pre code .code-line:nth-child(even) { background: #ffffff; }
			.nb-output-stream, .nb-output-plain { background:transparent; color:inherit; padding:0; border-radius:4px; overflow:auto }
			.nb-outputs .output-lines { border-radius:4px; overflow:auto; }
			.nb-outputs .output-lines .output-line { display:block; padding:6px 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Courier New', monospace; white-space:pre-wrap; }
			.nb-outputs .output-lines .output-line:nth-child(odd) { background:#f7f7f7; }
			.nb-outputs .output-lines .output-line:nth-child(even) { background:#ffffff; }
			.nb-output-error { background:#fee; color:#900; padding:8px; border-radius:4px; overflow:auto }

			/* token colors */
			.tok-keyword { color:#0000ff; font-weight:600 }
			.tok-comment { color:#6a9955; font-style:italic }
			.tok-string { color:#a31515 }
			.tok-number { color:#098658 }
		</style>
	</head>
	<body>
		<!-- header removed: no last-loaded timestamp -->

		<!-- 由 client-side 直接載入並解析 test.ipynb -->
		<div id="notebook" class="frame-wrap"></div>

		<!-- 依賴：marked (markdown) 與 highlight.js (code highlight) -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

		<script>
		// 直接載入並解析 JSON 格式的 test.ipynb，當只更新 .ipynb 時也會展示最新內容
		function escapeHtml(s) {
			return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}

		async function renderNotebook(url) {
			const container = document.getElementById('notebook');
			container.innerHTML = '<p style="color:#666;margin:0">載入中…</p>';
			try {
				const res = await fetch(url, {cache: 'no-store'});
				if (!res.ok) throw new Error('fetch failed: ' + res.status);
				const nb = await res.json();
				const cells = nb.cells || [];
				const out = [];
				out.push('<div class="nb-root">');
				// Notebook title hidden by request
				cells.forEach((cell, i) => {
					if (cell.cell_type === 'markdown') {
						const src = Array.isArray(cell.source) ? cell.source.join('') : (cell.source || '');
						const md = marked.parse(src);
						out.push('<div class="nb-cell nb-markdown">' + md + '</div>');
					} else if (cell.cell_type === 'code') {
						const src = Array.isArray(cell.source) ? cell.source.join('') : (cell.source || '');
						// code: 將每一行包成 .code-line
						const lines = src.split(/\r\n|\r|\n/);
						// pick bar color based on language metadata
						const lang = (cell.metadata && cell.metadata.language) ? (cell.metadata.language.toLowerCase()) : '';
						const langColorMap = {
							python: '#2b9a3e',
							py: '#2b9a3e',
							c: '#2b6cff',
							cpp: '#2b6cff',
							javascript: '#f0db4f',
							js: '#f0db4f',
							bash: '#9b59b6',
							sh: '#9b59b6'
						};
						const barColor = langColorMap[lang] || '#9bb8ff';
						out.push('<div class="nb-cell">');
						out.push('<div class="nb-code" style="--bar-color:' + barColor + '"><pre><code>');
						lines.forEach(line => {
							out.push('<span class="code-line">' + highlightCodeLine(line, lang) + '</span>');
						});
						out.push('</code></pre></div>');
						// outputs: 與 code 同級（分離）
						const outputs = cell.outputs || [];
						if (outputs.length) {
							out.push('<div class="nb-outputs">');
							outputs.forEach(outp => {
								if (outp.output_type === 'stream') {
									const txt = Array.isArray(outp.text) ? outp.text.join('') : (outp.text || '');
									const linesOut = txt.split(/\r\n|\r|\n/);
									out.push('<div class="output-lines nb-output-stream">');
									linesOut.forEach(l => out.push('<span class="output-line">' + escapeHtml(l) + '</span>'));
									out.push('</div>');
								} else if (outp.output_type === 'execute_result' || outp.output_type === 'display_data') {
									const data = outp.data || {};
									if (data['text/html']) {
										const html = Array.isArray(data['text/html']) ? data['text/html'].join('') : data['text/html'];
										out.push('<div class="nb-output-html">' + html + '</div>');
									} else if (data['image/png']) {
										out.push('<img class="nb-output-img" src="data:image/png;base64,' + data['image/png'] + '" />');
									} else if (data['text/plain']) {
										const txt = Array.isArray(data['text/plain']) ? data['text/plain'].join('') : data['text/plain'];
										const linesOut = txt.split(/\r\n|\r|\n/);
										out.push('<div class="output-lines nb-output-plain">');
										linesOut.forEach(l => out.push('<span class="output-line">' + escapeHtml(l) + '</span>'));
										out.push('</div>');
									} else {
										// fallback: try JSON stringify
										const txt = escapeHtml(JSON.stringify(data));
										const linesOut = txt.split(/\r\n|\r|\n/);
										out.push('<div class="output-lines nb-output-plain">');
										linesOut.forEach(l => out.push('<span class="output-line">' + escapeHtml(l) + '</span>'));
										out.push('</div>');
									}
								} else if (outp.output_type === 'error') {
									const err = (outp.ename || '') + ': ' + ((outp.evalue || '')) + '\n' + (outp.traceback ? outp.traceback.join('\n') : '');
									const errLines = (escapeHtml(err)).split(/\r\n|\r|\n/);
									out.push('<div class="nb-output-error">');
									errLines.forEach(l => out.push('<div>' + l + '</div>'));
									out.push('</div>');
								}
							});
							out.push('</div>');
						}
						out.push('</div>');
					}
				});
				out.push('</div>');
				container.innerHTML = out.join('');
				// （目前以交錯背景為主）
			} catch (err) {
				container.innerHTML = '<div class="fallback">載入失敗：' + escapeHtml(String(err)) + '</div>';
			}
		}

		// --- 簡易逐行語法著色器 (目前支援 Python 基本 token)
		function escapeHtmlNoTrim(s) {
			return (s||'').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}

		function highlightCodeLine(line, lang) {
			if (!line) return '';
			if (lang === 'python' || lang === 'py') {
				const keywords = new Set(['def','return','if','else','elif','for','while','import','from','as','class','try','except','finally','with','lambda','pass','break','continue','True','False','None','in','is','and','or','not','yield','global','nonlocal','assert','raise']);
				let out = '';
				let i = 0;
				const n = line.length;
				let inStr = false; let strChar = null; let buf = '';
				function flushBuf() {
					if (!buf) return;
					if (/^\d+(\.\d+)?$/.test(buf)) {
						out += '<span class="tok-number">'+buf+'</span>';
					} else if (keywords.has(buf)) {
						out += '<span class="tok-keyword">'+buf+'</span>';
					} else {
						out += buf.split(/([_a-zA-Z][_a-zA-Z0-9]*)/).map(part=>{
							return part && /^[A-Za-z_][_A-Za-z0-9]*$/.test(part) && keywords.has(part) ? '<span class="tok-keyword">'+part+'</span>' : part;
						}).join('');
					}
					buf = '';
				}
				while (i < n) {
					const ch = line[i];
					if (inStr) {
						buf += escapeHtmlNoTrim(ch);
						if (ch === strChar && line[i-1] !== '\\') {
							out += '<span class="tok-string">'+buf+'</span>';
							buf = '';
							inStr = false; strChar = null;
						}
						i++; continue;
					}
					if (ch === '"' || ch === "'") {
						flushBuf(); inStr = true; strChar = ch; buf = escapeHtmlNoTrim(ch); i++; continue;
					}
					if (ch === '#') {
						flushBuf(); // rest is comment
						const comment = escapeHtmlNoTrim(line.slice(i));
						out += '<span class="tok-comment">'+comment+'</span>';
						break;
					}
					if ((/[A-Za-z0-9_]/).test(ch)) {
						buf += ch; i++; continue;
					} else {
						flushBuf(); out += escapeHtmlNoTrim(ch); i++; continue;
					}
				}
				flushBuf();
				return out;
			} else {
				// fallback: plain escaped
				return escapeHtmlNoTrim(line);
			}
		}

		window.addEventListener('DOMContentLoaded', function () {
			const btn = document.getElementById('reloadBtn');
			function loadLatest() {
				const t = Date.now();
				// 加上 query 破壞快取，確保讀到最新的 test.ipynb
				renderNotebook('test.ipynb?v=' + t);
			}
			if (btn) btn.addEventListener('click', loadLatest);
			loadLatest();
			// optional: 也可以每隔一段時間自動重新載入
			// setInterval(loadLatest, 30_000);
		});
		</script>
	</body>
</html>

