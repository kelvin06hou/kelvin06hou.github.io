<!doctype html>
<html lang="zh-Hant">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Notebook Embed</title>
		<style>
			body { font-family: Arial, sans-serif; margin: 24px; }
			.frame-wrap { width: 100%; height: 80vh; border: 1px solid #ddd; }
			.fallback { margin-top: 12px; }
		</style>
	</head>
	<body>
		<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
			<button id="reloadBtn">重新載入 Notebook（取最新）</button>
			<span id="lastLoaded" style="color:#666;font-size:0.95rem;"></span>
		</div>

		<!-- 由 client-side 直接載入並解析 test.ipynb -->
		<div id="notebook" class="frame-wrap"></div>

		<!-- 依賴：marked (markdown) 與 highlight.js (code highlight) -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

		<script>
		// 直接載入並解析 JSON 格式的 test.ipynb，當只更新 .ipynb 時也會展示最新內容
		function escapeHtml(s) {
			return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
		}

		async function renderNotebook(url) {
			const container = document.getElementById('notebook');
			const last = document.getElementById('lastLoaded');
			container.innerHTML = '<p style="color:#666">載入中…</p>';
			try {
				const res = await fetch(url, {cache: 'no-store'});
				if (!res.ok) throw new Error('fetch failed: ' + res.status);
				const nb = await res.json();
				const cells = nb.cells || [];
				const out = [];
				out.push('<div class="nb-root">');
				out.push('<h2>' + (nb.metadata?.title || 'Notebook') + '</h2>');
				cells.forEach((cell, i) => {
					if (cell.cell_type === 'markdown') {
						const src = Array.isArray(cell.source) ? cell.source.join('') : (cell.source || '');
						const md = marked.parse(src);
						out.push('<div class="nb-cell nb-markdown">' + md + '</div>');
					} else if (cell.cell_type === 'code') {
						const src = Array.isArray(cell.source) ? cell.source.join('') : (cell.source || '');
						out.push('<div class="nb-cell nb-code"><pre><code>' + escapeHtml(src) + '</code></pre>');
						// outputs
						const outputs = cell.outputs || [];
						if (outputs.length) {
							out.push('<div class="nb-outputs">');
							outputs.forEach(outp => {
								if (outp.output_type === 'stream') {
									const txt = Array.isArray(outp.text) ? outp.text.join('') : (outp.text || '');
									out.push('<pre class="nb-output-stream">' + escapeHtml(txt) + '</pre>');
								} else if (outp.output_type === 'execute_result' || outp.output_type === 'display_data') {
									const data = outp.data || {};
									if (data['text/html']) {
										const html = Array.isArray(data['text/html']) ? data['text/html'].join('') : data['text/html'];
										out.push('<div class="nb-output-html">' + html + '</div>');
									} else if (data['image/png']) {
										out.push('<img class="nb-output-img" src="data:image/png;base64,' + data['image/png'] + '" />');
									} else if (data['text/plain']) {
										const txt = Array.isArray(data['text/plain']) ? data['text/plain'].join('') : data['text/plain'];
										out.push('<pre class="nb-output-plain">' + escapeHtml(txt) + '</pre>');
									} else {
										// fallback: try JSON stringify
										out.push('<pre class="nb-output-plain">' + escapeHtml(JSON.stringify(data)) + '</pre>');
									}
								} else if (outp.output_type === 'error') {
									const err = (outp.ename || '') + ': ' + ((outp.evalue || '')) + '\n' + (outp.traceback ? outp.traceback.join('\n') : '');
									out.push('<pre class="nb-output-error">' + escapeHtml(err) + '</pre>');
								}
							});
							out.push('</div>');
						}
						out.push('</div>');
					}
				});
				out.push('</div>');
				container.innerHTML = out.join('');
				// highlight code blocks
				document.querySelectorAll('#notebook pre code').forEach(block => {
					try { hljs.highlightBlock(block); } catch (e) {}
				});
				if (last) last.textContent = '上次載入：' + new Date().toLocaleString();
			} catch (err) {
				container.innerHTML = '<div class="fallback">載入失敗：' + escapeHtml(String(err)) + '</div>';
				if (last) last.textContent = '載入失敗';
			}
		}

		window.addEventListener('DOMContentLoaded', function () {
			const btn = document.getElementById('reloadBtn');
			function loadLatest() {
				const t = Date.now();
				// 加上 query 破壞快取，確保讀到最新的 test.ipynb
				renderNotebook('test.ipynb?v=' + t);
			}
			if (btn) btn.addEventListener('click', loadLatest);
			loadLatest();
			// optional: 也可以每隔一段時間自動重新載入
			// setInterval(loadLatest, 30_000);
		});
		</script>
	</body>
</html>

